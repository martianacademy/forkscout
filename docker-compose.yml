# ─── Forkscout Agent — Docker Compose ───
#
# Usage:
#   docker compose up -d              # start (pulls pre-built image or builds locally)
#   docker compose up -d --build      # force local build from Dockerfile
#   docker compose pull && docker compose up -d  # use latest image from ghcr.io
#   docker compose logs -f agent      # follow logs
#   docker compose down               # stop all
#
# Copy .env.example → .env and fill in your keys before starting.

services:
  agent:
    image: ghcr.io/martianacademy/forkscout:latest
    build: .
    container_name: forkscout-agent
    restart: unless-stopped
    ports:
      - "${AGENT_PORT:-3210}:3210"
    env_file:
      - .env
    environment:
      - AGENT_PORT=3210
      # Point SearXNG to the compose service
      - SEARXNG_URL=http://searxng:8080
    volumes:
      # Named volume: on first run Docker copies the image's agent code into this volume.
      # All agent self-edits, memory, cron jobs, auth — everything persists here,
      # even across `docker compose down` + `up` or image updates.
      # To reset to a fresh image state: docker volume rm forkscout_agent-data
      - agent-data:/app/packages/agent
      # Anonymous volume keeps Linux-compiled node_modules from the image build.
      # To update deps after a Dockerfile change: docker compose up --build -V
      - /app/packages/agent/node_modules
    depends_on:
      searxng:
        condition: service_healthy

  # SearXNG — private search engine (used by web_search tool)
  searxng:
    image: searxng/searxng:latest
    container_name: forkscout-searxng
    restart: unless-stopped
    ports:
      - "${SEARXNG_PORT:-8888}:8080"
    environment:
      - SEARXNG_BASE_URL=http://localhost:${SEARXNG_PORT:-8888}/
    volumes:
      - searxng-data:/etc/searxng
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 3

volumes:
  agent-data:
  searxng-data:
